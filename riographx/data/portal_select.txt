insert into select_out ( id_instance, id_experiment, id_activity, optifunc, evaluatedvalue, maxresults, caixa1, gorder, function, paramid, grafo ) select %ID_PIP%, %ID_EXP%, %ID_ACT%, optifunc, evaluatedvalue, maxresults, caixa1, gorder, function, paramid, grafo from ( WITH l AS ( SELECT CASE WHEN caixa1 = 'min' THEN maxresults ELSE 0 END AS lim_a, CASE WHEN caixa1 = 'max' THEN maxresults ELSE 0 END AS lim_d FROM evaluate_out where id_experiment = %ID_EXP% LIMIT 1 )( select * from ( select eo.*, sp.id_instance, row_number() over ( partition by eo.gorder order by CAST( eo.evaluatedvalue as float) asc) as rownum from evaluate_out eo join spectral_parameters sp on sp.id_instance = eo.paramid and sp.gorder::text = eo.gorder::text where eo.id_experiment = %ID_EXP% ) tmp where rownum <= ( SELECT lim_a FROM l ) ) union all ( select * from ( select eo.*, sp.id_instance, row_number() over (partition by eo.gorder order by CAST(eo.evaluatedvalue as float) desc) as rownum from evaluate_out eo join spectral_parameters sp on sp.id_instance = eo.paramid and sp.gorder::text = eo.gorder::text where eo.id_experiment = %ID_EXP% ) tmp where rownum <= (SELECT lim_d FROM l) ) ) as t1 where id_experiment = %ID_EXP%  